# Apple Health Import Guide

**Complete pipeline documentation for importing Apple Health data into Redis.**

This guide explains the full data flow from Apple Health XML export to Redis storage, including all scripts, data transformations, and validation steps.

---

## 📊 Data Pipeline Overview

```
Apple Health Export (iOS)
         ↓
   export.xml (84 MB)
         ↓
   AppleHealthParser (backend/src/apple_health/parser.py)
         ↓
   parsed_health_data.json (34 MB) [OPTIONAL CACHE]
         ↓
   import_health_data.py
         ↓
   Redis (with indexes + enrichment)
         ↓
   Chat Agent (queries via tools)
```

**Two import paths:**
1. **XML → Redis** (slow, ~2-5 minutes for large files)
2. **JSON → Redis** (fast, ~2-5 seconds with pre-parsed data)

---

## 🚀 Quick Start

### Prerequisites

```bash
# 1. Ensure Redis is running
docker-compose ps | grep redis

# 2. Verify backend dependencies installed
cd backend
uv sync
```

### Import Commands

```bash
# Fast path: From pre-parsed JSON (RECOMMENDED)
uv run python import_health_data.py parsed_health_data.json

# Slow path: From XML export (first-time import)
uv run python import_health_data.py apple_health_export/export.xml

# Auto-detect (looks for JSON first, then XML)
uv run python import_health_data.py
```

**Expected output:**
```
================================================================================
  Apple Health Data Import
================================================================================

👤 User ID: wellness_user
🔌 Redis: localhost:6379

📄 Loading JSON: parsed_health_data.json (34.0 MB)
✅ Enriched 154 workouts with computed fields
✅ Parsed 255,002 records

💾 Storing in Redis...
✅ Stored: health:user:wellness_user:data
✅ Created 20 metric indices

📊 Indexing 154 workouts...
✅ Indexed by day: 154
✅ Indexed by date: 154

================================================================================
✅ Import completed successfully!
================================================================================

💡 Test it:
   Frontend: http://localhost:3000
   API: http://localhost:8000/docs

💡 If chat agent says "No workouts found" but import succeeded:
   python rebuild_workout_indexes.py
```

---

## 📂 File Locations

### Input Files

| File | Size | Purpose | Source |
|------|------|---------|--------|
| `apple_health_export/export.xml` | 84 MB | Raw Apple Health XML export | iOS Health app → Export Health Data |
| `parsed_health_data.json` | 34 MB | Pre-parsed JSON cache (optional) | Generated by parser or manual script |

### Scripts

| Script | Purpose | When to Use |
|--------|---------|-------------|
| **`import_health_data.py`** (root) | Main import script | **Use this for all imports** |
| **`rebuild_workout_indexes.py`** (root) | Rebuild Redis workout indexes | When indexes are empty or tools return "No workouts found" |
| `backend/src/apple_health/parser.py` | Secure XML parser library | Used internally by import script |

### Output (Redis)

| Key Pattern | Type | Purpose | TTL |
|-------------|------|---------|-----|
| `health:user:{user_id}:data` | STRING (JSON) | Main health data | 7 months |
| `health:user:{user_id}:metric:{type}` | STRING (JSON) | Per-metric indexes | 7 months |
| `user:{user_id}:workout:days` | HASH | Workout count by day | 7 months |
| `user:{user_id}:workout:by_date` | SORTED SET | Workouts by timestamp | 7 months |

---

## 🔧 How It Works

### 1. Export Apple Health Data (iOS)

**On your iPhone:**
1. Open **Health app**
2. Tap **Profile** (top-right)
3. Scroll down → **Export All Health Data**
4. Wait for export to complete (~2-10 minutes)
5. **AirDrop** or save `export.xml` to your Mac
6. Move `export.xml` to `redis-wellness/apple_health_export/`

**Result:** `apple_health_export/export.xml` (84 MB)

---

### 2. Parse XML to JSON (Optional, One-Time)

**Why parse to JSON?**
- Parsing XML is slow (~2-5 minutes for 84 MB files)
- JSON cache allows fast re-imports during development
- JSON is easier to inspect and validate

**How to create `parsed_health_data.json`:**

**Option A: Import script creates it automatically (NOT IMPLEMENTED YET)**
```bash
# This will create parsed_health_data.json as a side effect
uv run python import_health_data.py apple_health_export/export.xml --cache-json
```

**Option B: Manual parsing script (if needed)**
```python
# scripts/parse_to_json.py (create if doesn't exist)
import sys
import json
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent / "backend" / "src"))

from apple_health.parser import AppleHealthParser

parser = AppleHealthParser(allowed_directories=["apple_health_export"])
health_data = parser.parse_file("apple_health_export/export.xml")

# Convert to JSON structure
data = {
    "record_count": health_data.record_count,
    "export_date": health_data.export_date.isoformat(),
    "metrics_records": {},
    "metrics_summary": {},
    "workouts": [],
}

# Process records...
# (see import_health_data.py lines 199-235 for full conversion)

with open("parsed_health_data.json", "w") as f:
    json.dump(data, f)

print(f"✅ Created parsed_health_data.json ({Path('parsed_health_data.json').stat().st_size / 1024 / 1024:.1f} MB)")
```

**Result:** `parsed_health_data.json` (34 MB, ~60% smaller than XML)

---

### 3. Import to Redis

**The `import_health_data.py` script handles:**

#### A. Data Validation & Enrichment

```python
# CRITICAL: Workouts MUST have these fields for chat agent tools
for workout in data.get('workouts', []):
    # Computed from startDate
    workout['day_of_week'] = dt.strftime('%A')      # "Friday"
    workout['date'] = dt.strftime('%Y-%m-%d')       # "2025-10-17"

    # Derived from type
    workout['type_cleaned'] = workout['type'].replace('HKWorkoutActivityType', '')

    # Standardized field
    workout['calories'] = workout['totalEnergyBurned']
```

**Why these fields matter:**
- `day_of_week`: Required by `get_workout_days_summary` tool
- `date`: Required for date-based queries
- `type_cleaned`: User-friendly workout type names
- `calories`: Standardized field for energy queries

**What happens if these fields are missing?**
- Workouts indexed as "Unknown" → chat agent can't find them
- Queries like "Do I work out on Mondays?" return incorrect results
- See issue fixed in summary: October 2025 workout enrichment validation

#### B. Redis Storage

```python
# 1. Store main health data
redis_client.set(
    "health:user:wellness_user:data",
    json.dumps(data)
)

# 2. Create metric indexes (fast lookup by metric type)
for metric_type, summary in data["metrics_summary"].items():
    redis_client.setex(
        f"health:user:wellness_user:metric:{metric_type}",
        18_144_000,  # 7 months TTL
        json.dumps(summary)
    )

# 3. Index workouts by day (O(1) aggregation)
redis_client.hincrby("user:wellness_user:workout:days", "Friday", 1)

# 4. Index workouts by date (O(log N) range queries)
redis_client.zadd(
    "user:wellness_user:workout:by_date",
    {"2025-10-17:TraditionalStrengthTraining": 1729184640.0}
)
```

#### C. Validation & Error Detection

```python
# Count enriched workouts
enriched_count = 154

# Validate indexing completeness
indexed_by_day = 154
if indexed_by_day < len(workouts) * 0.9:  # <90% indexed
    print(f"⚠️  WARNING: Only {indexed_by_day}/{len(workouts)} workouts indexed")
    print("   Check that workouts have valid 'day_of_week' fields")
```

**The script will warn you if:**
- Workouts missing required fields
- Date parsing fails for any records
- Less than 90% of workouts are successfully indexed
- Any enrichment step fails

---

### 4. Rebuild Workout Indexes (If Needed)

**When to rebuild indexes:**
- After importing data but indexes are empty
- Tools returning "No workouts found" despite data existing
- After manual data modifications in Redis
- Performance degradation on workout queries

**Why indexes matter:**
- **50-100x speedup** for workout queries (O(log N) vs O(N) JSON parsing)
- Enable fast date-range queries (`get_workouts_in_date_range`)
- Support efficient day-of-week aggregations (`get_workout_schedule_analysis`)
- Power pattern analysis tools

**Rebuild script:**

```bash
# From project root
python rebuild_workout_indexes.py
```

**Expected output:**
```
2025-10-24 05:09:15 INFO   Rebuilding workout indexes for user: wellness_user
2025-10-24 05:09:15 INFO   Found 154 workouts in JSON data
2025-10-24 05:09:15 INFO   Building Redis indexes...
2025-10-24 05:09:15 INFO   ✅ Successfully indexed 154 workouts
2025-10-24 05:09:15 INFO   Created 156 Redis keys

2025-10-24 05:09:15 INFO   Verification:
2025-10-24 05:09:15 INFO     Total workouts indexed: 146
2025-10-24 05:09:15 INFO     Workouts by day: {'Friday': 24, 'Wednesday': 27, 'Monday': 27, 'Saturday': 17, 'Sunday': 19, 'Thursday': 16, 'Tuesday': 24}
```

**What the script does:**

1. **Fetches workouts from Redis JSON** (`health:user:{user_id}:data`)
2. **Creates Redis indexes:**
   - `user:{user_id}:workout:by_date` - SORTED SET (timestamp-based range queries)
   - `user:{user_id}:workout:days` - HASH (day-of-week aggregations)
   - `user:{user_id}:workout:{id}` - HASH (individual workout details)
3. **Verifies indexing** - Reports total count and day distribution

**Index data structures:**

```redis
# Sorted set: Fast date-range queries (O(log N))
ZADD user:wellness_user:workout:by_date 1729184640.0 "2025-10-17:TraditionalStrengthTraining:180801"

# Hash: Fast day-of-week counts (O(1))
HINCRBY user:wellness_user:workout:days "Friday" 1

# Hash: Individual workout details (O(1) lookup)
HSET user:wellness_user:workout:2025-10-17:TraditionalStrengthTraining:180801
  "type" "TraditionalStrengthTraining"
  "date" "2025-10-17"
  "day_of_week" "Friday"
  "duration_minutes" "52.4"
  "calories" "318.365"
```

**Performance comparison:**

| Query Type | JSON Parsing | Redis Indexes | Speedup |
|------------|-------------|---------------|---------|
| Last 30 days | ~50ms | ~1ms | 50x |
| Date range | ~100ms | ~2ms | 50x |
| Day-of-week count | ~80ms | ~0.5ms | 160x |
| All workouts | ~120ms | ~150ms | 0.8x (slower) |

**Note:** Indexes are automatically created during initial import. Only use `rebuild_workout_indexes.py` if indexes are missing or corrupted.

---

## 🔍 Validation & Testing

### 1. Verify Redis Data

```bash
# Check main health data exists
docker exec -it redis-wellness-redis-1 redis-cli GET "health:user:wellness_user:data" | wc -c

# Count metric indexes
docker exec -it redis-wellness-redis-1 redis-cli KEYS "health:user:wellness_user:metric:*" | wc -l

# Check workout day distribution
docker exec -it redis-wellness-redis-1 redis-cli HGETALL "user:wellness_user:workout:days"

# Count workouts by date
docker exec -it redis-wellness-redis-1 redis-cli ZCARD "user:wellness_user:workout:by_date"
```

**Expected results:**
```
Main health data: ~35,000,000 bytes (35 MB)
Metric indexes: 20 keys
Workout days: Friday(24), Monday(27), Wednesday(27), Saturday(17), Sunday(19), Thursday(16), Tuesday(24)
Workouts by date: 154
```

### 2. Test Chat Agent

```bash
# Start services
./start.sh

# Open frontend
open http://localhost:3000
```

**Test queries:**
```
1. "Tell me about my recent workouts"
   Expected: Shows last 30 days of workouts with dates, types, calories

2. "Do I work out consistently on Mondays?"
   Expected: Shows Monday workout count and patterns

3. "What was my average heart rate last week?"
   Expected: Shows heart rate data with dates and values
```

### 3. Inspect Parsed JSON (Manual Validation)

```bash
# View parsed JSON structure
python3 -c "import json; data = json.load(open('parsed_health_data.json')); print(f'Records: {data[\"record_count\"]:,}\\nMetrics: {len(data[\"metrics_summary\"])}\\nWorkouts: {len(data[\"workouts\"])}')"

# Check first workout has required fields
python3 -c "import json; w = json.load(open('parsed_health_data.json'))['workouts'][0]; print('Required fields:', 'day_of_week' in w, 'date' in w, 'type_cleaned' in w, 'calories' in w)"
```

**Expected:**
```
Records: 255,002
Metrics: 20
Workouts: 154

Required fields: True True True True
```

---

## 🛠️ Troubleshooting

### Issue: "No health data found for user"

**Cause:** Redis doesn't have imported data or wrong user_id

**Fix:**
```bash
# Check if data exists in Redis
docker exec -it redis-wellness-redis-1 redis-cli GET "health:user:wellness_user:data"

# Re-import data
uv run python import_health_data.py
```

---

### Issue: "It seems you haven't worked out in the last 30 days" (but you have)

**Possible causes:**
1. Workouts missing `day_of_week` field (indexed as "Unknown")
2. Redis workout indexes are empty or corrupted

**Fix Option 1: Re-import with enrichment validation**
```bash
# Re-import with enrichment validation (script will detect and fix)
uv run python import_health_data.py parsed_health_data.json

# Verify enrichment worked
docker exec -it redis-wellness-redis-1 redis-cli HGETALL "user:wellness_user:workout:days"
# Should show real days, NOT "Unknown"
```

**Fix Option 2: Rebuild workout indexes**
```bash
# If data exists in Redis but indexes are empty
python rebuild_workout_indexes.py

# Verify indexes were rebuilt
docker-compose exec redis redis-cli ZCARD "user:wellness_user:workout:by_date"
# Should show workout count (e.g., 146)
```

**How to diagnose:**
```bash
# Check if main health data exists
docker-compose exec redis redis-cli GET "health:user:wellness_user:data" | wc -c
# Should show large number (e.g., 35000000 bytes)

# Check if indexes exist
docker-compose exec redis redis-cli ZCARD "user:wellness_user:workout:by_date"
# Should show workout count, or 0 if indexes missing

# If data exists but indexes = 0, run rebuild_workout_indexes.py
```

**Root cause (October 2025):** Import script had silent `except: pass` that hid enrichment failures. Now fixed with explicit validation. Additionally, indexes may not have been created during initial import.

---

### Issue: "Failed to parse date" warnings during import

**Cause:** Some health records have malformed dates

**Fix:**
- Script continues with fallback values (doesn't break import)
- Check `parsed_health_data.json` for records with unusual date formats
- Parser handles both ISO 8601 and legacy formats automatically

---

### Issue: XML parsing is very slow

**Expected behavior:** Parsing 84 MB XML takes 2-5 minutes

**Optimization:**
1. Use JSON cache after first import (fast path)
2. Parser uses iterative parsing (memory-safe for large files)
3. If parsing fails halfway, restart Docker (memory constraints)

---

### Issue: Import script can't find Redis

**Cause:** Docker containers not running

**Fix:**
```bash
# Check Docker status
docker-compose ps

# Start services
./start.sh

# Or manually
docker-compose up -d redis
```

---

## 📋 Data Formats

### XML Format (Apple Health Export)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HealthData [...]>
<HealthData locale="en_US">
  <ExportDate value="2025-10-19 18:07:04 -0400"/>

  <Me HKCharacteristicTypeIdentifierDateOfBirth="1990-01-01"
      HKCharacteristicTypeIdentifierBiologicalSex="HKBiologicalSexMale"/>

  <Record type="HKQuantityTypeIdentifierBodyMass"
          sourceName="Health"
          unit="lb"
          value="138.6"
          startDate="2025-10-17 09:30:00 -0400"
          endDate="2025-10-17 09:30:00 -0400"
          creationDate="2025-10-17 09:30:15 -0400"/>

  <Workout workoutActivityType="HKWorkoutActivityTypeTraditionalStrengthTraining"
           duration="52.436"
           durationUnit="min"
           startDate="2025-10-17 09:44:00 -0400"
           endDate="2025-10-17 10:36:26 -0400"
           sourceName="Apple Watch">
    <WorkoutStatistics type="HKQuantityTypeIdentifierActiveEnergyBurned"
                       sum="318.365" unit="kcal"/>
  </Workout>
</HealthData>
```

---

### JSON Format (Pre-Parsed Cache)

```json
{
  "record_count": 255002,
  "export_date": "2025-10-19T22:07:04+00:00",

  "metrics_summary": {
    "BodyMass": {
      "count": 1500,
      "latest_value": "138.6 lb",
      "latest_date": "2025-10-17T13:30:00+00:00"
    }
  },

  "metrics_records": {
    "BodyMass": [
      {
        "date": "2025-10-17T13:30:00+00:00",
        "value": "138.6",
        "unit": "lb",
        "source": "Health"
      }
    ]
  },

  "workouts": [
    {
      "type": "HKWorkoutActivityTypeTraditionalStrengthTraining",
      "workoutActivityType": "HKWorkoutActivityTypeTraditionalStrengthTraining",
      "startDate": "2025-10-17T13:44:00+00:00",
      "endDate": "2025-10-17T14:36:26+00:00",
      "date": "2025-10-17",
      "day_of_week": "Friday",
      "type_cleaned": "TraditionalStrengthTraining",
      "duration": 3146.16,
      "duration_minutes": 52.4,
      "calories": 318.365,
      "totalEnergyBurned": 318.365,
      "totalDistance": null,
      "source": "Apple Watch"
    }
  ]
}
```

**Key transformations:**
- Dates: Converted to ISO 8601 UTC (`2025-10-17T13:44:00+00:00`)
- Workout enrichment: Added `day_of_week`, `date`, `type_cleaned`, `calories`
- Normalized units: Weight converted to lbs, duration to minutes

---

### Redis Format (Stored Data)

```redis
# Main health data (STRING)
GET health:user:wellness_user:data
→ {full JSON from parsed_health_data.json}

# Metric index (STRING)
GET health:user:wellness_user:metric:BodyMass
→ {"count": 1500, "latest_value": "138.6 lb", "latest_date": "2025-10-17T13:30:00+00:00"}

# Workout day counts (HASH)
HGETALL user:wellness_user:workout:days
→ Friday: 24, Monday: 27, Wednesday: 27, Saturday: 17, Sunday: 19, Thursday: 16, Tuesday: 24

# Workouts by date (SORTED SET)
ZRANGEBYSCORE user:wellness_user:workout:by_date -inf +inf WITHSCORES LIMIT 0 5
→ 2025-10-17:TraditionalStrengthTraining 1729184640.0
```

---

## 🔐 Security & Privacy

**All data stays local:**
- ✅ XML parsing is fully local (no external API calls)
- ✅ Redis runs in Docker container (localhost only)
- ✅ Chat agent uses local Ollama (no cloud LLMs)
- ✅ Health data NEVER leaves your machine

**Parser security features:**
- ✅ XXE attack protection (no external entity expansion)
- ✅ XML bomb protection (element count limits)
- ✅ Directory traversal prevention (allowed directories only)
- ✅ Memory-safe iterative parsing (clears elements after processing)
- ✅ Privacy-preserving error messages (no sensitive data in logs)

**See:** `backend/src/apple_health/parser.py` for full security implementation

---

## 📚 Related Documentation

- **`/docs/REDIS_USAGE_GUIDE.md`** - Complete Redis data structure documentation
- **`/docs/WHY_NO_LANGGRAPH.md`** - Architecture decision for simple tool loops
- **`/docs/HEALTH_DATA_PIPELINE.md`** - Deep dive into Apple Health processing (if exists)
- **`/backend/src/apple_health/query_tools/`** - All 9 health query tools used by chat agent

---

## 🎯 Key Takeaways

**For Users:**
1. Use `import_health_data.py` for all imports (auto-detects XML vs JSON)
2. JSON cache is faster for development (re-import in seconds)
3. Script validates enrichment automatically (warns about missing fields)
4. All data is local and private (no external APIs)

**For Developers:**
1. Workouts MUST have `day_of_week`, `date`, `type_cleaned`, `calories` fields
2. Parser normalizes all dates to ISO 8601 UTC
3. Redis indexes enable O(1) aggregations for chat agent tools
4. Import script validates >90% indexing success

**For Claude:**
1. Read this doc before touching import/parsing code
2. Never remove enrichment validation (prevents silent failures)
3. Use `RedisKeys` utility for all key generation
4. Test chat agent queries after any import changes

---

## ✅ Success Checklist

After import, verify:
- [ ] Redis has `health:user:wellness_user:data` key
- [ ] Metric indexes created (20 keys)
- [ ] Workout indexes populated (`ZCARD user:wellness_user:workout:by_date` > 0)
- [ ] Workout days show real names (NOT "Unknown")
- [ ] Chat agent can answer: "Tell me about my recent workouts"
- [ ] Import script reported 0 warnings
- [ ] JSON file has `day_of_week` field in all workouts

**If all checks pass: System is ready for health queries! 🎉**

**If workout indexes are missing:**
```bash
# Run the rebuild script
python rebuild_workout_indexes.py

# Verify indexes were created
docker-compose exec redis redis-cli ZCARD "user:wellness_user:workout:by_date"
# Should show workout count (e.g., 146)
```
